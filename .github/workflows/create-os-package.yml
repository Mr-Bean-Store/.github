name: Create OS Package
on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      file-ext:
        required: true
        type: string
      file-name:
        required: true
        type: string
      upload-url:
        required: true
        type: string

jobs:
  Create-Executable:
    if: contains(github.ref, 'main') || contains(github.ref, 'develop') || contains(github.ref, 'tag_action') 
    runs-on: ${{ github.event.inputs.os }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Branch
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: maven

      - name: Create Essential Packages
        working-directory: cli
        run: ${{ github.event.inputs.os != 'windows-latest' && 'chmod +x ./mvnw &&' || '' }} ./mvnw package
      
      - name: Create Runtime
        working-directory: cli
        run: |
          jlink --output minimal-jvm --module-path ./target/lib --add-modules java.base,java.xml,java.sql,java.prefs,java.desktop
      
      - name: Build Artifacts
        working-directory: cli
        run: |
          jpackage --type ${{ github.event.inputs.file-ext }} -n MrBeanStoreCLI --runtime-image minimal-jvm --main-jar MrBeanStoreCLI-0.0.1-SNAPSHOT.jar -i ${{ github.event.inputs.os == 'windows-latest' && '.\target\ --win-menu --win-console' || './target' }}

      - name: Upload CLI Artifactis
        id: release_artifact
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.inputs.upload_url }}
          asset_path: ./cli/${{ github.event.inputs.file-name }}
          asset_name: ${{ github.event.inputs.file-name }}
          asset_content_type: application/zip